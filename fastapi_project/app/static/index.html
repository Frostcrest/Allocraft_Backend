<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portfolio Positions</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 32px;
        }

        th,
        td {
            padding: 8px 12px;
            border: 1px solid #ccc;
        }

        form>* {
            margin: 0 8px 8px 0;
        }

        h2 {
            margin-top: 40px;
        }
    </style>
</head>

<body>
    <h1>Portfolio Positions</h1>

    <!-- STOCKS SECTION -->
    <section>
        <h2>Stocks</h2>
        <form id="stockForm">
            <input type="hidden" name="id" />
            <input name="ticker" placeholder="Ticker" required />
            <input name="shares" type="number" min="0" step="any" placeholder="Shares" required />
            <input name="cost_basis" type="number" step="0.01" min="0" placeholder="Cost Basis" required />
            <input name="market_price" type="number" step="0.01" min="0" placeholder="Market Price" />
            <select name="status" required>
                <option value="Open">Open</option>
                <option value="Sold">Sold</option>
            </select>
            <input name="entry_date" type="date" placeholder="Entry Date" />
            <button type="submit">Add / Update Stock</button>
            <button type="button" id="cancelStockEdit" style="display:none;">Cancel</button>
        </form>

        <table id="stocksTable">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Shares</th>
                    <th>Cost Basis</th>
                    <th>Market Price</th>
                    <th>Status</th>
                    <th>Entry Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- OPTIONS SECTION -->
    <section>
        <h2>Options</h2>
        <form id="optionForm">
            <input type="hidden" name="id" />
            <input name="ticker" placeholder="Ticker" required />
            <select name="option_type" required>
                <option value="" disabled selected>Option Type</option>
                <option value="Call">Call</option>
                <option value="Put">Put</option>
            </select>
            <input name="strike_price" type="number" step="0.01" min="0" placeholder="Strike Price" required />
            <input name="expiry_date" type="date" placeholder="Expiry Date" required />
            <input name="contracts" type="number" min="1" step="any" placeholder="Contracts" required />
            <input name="cost" type="number" step="0.01" min="0" placeholder="Total Cost" required />
            <input name="market_price_per_contract" type="number" step="0.01" min="0" placeholder="Market Price/Contract" />
            <select name="status" required>
                <option value="Open">Open</option>
                <option value="Closed">Closed</option>
            </select>
            <button type="submit">Add / Update Option</button>
            <button type="button" id="cancelOptionEdit" style="display:none;">Cancel</button>
        </form>

        <table id="optionsTable">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Type</th>
                    <th>Strike Price</th>
                    <th>Expiry Date</th>
                    <th>Contracts</th>
                    <th>Cost</th>
                    <th>Market Price/Contract</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- LEAPS SECTION -->
    <section>
        <h2>LEAPS</h2>
        <form id="leapForm">
            <input type="hidden" name="id" />
            <input name="ticker" placeholder="Ticker" required />
            <input name="contract_info" placeholder="Contract Info (e.g., '$150 Call Jan 2026')" required />
            <input name="cost" type="number" step="0.01" min="0" placeholder="Premium Paid" required />
            <input name="current_price" type="number" step="0.01" min="0" placeholder="Current Price" />
            <input name="expiry_date" type="date" placeholder="Expiry Date" required />
            <button type="submit">Add / Update LEAP</button>
            <button type="button" id="cancelLeapEdit" style="display:none;">Cancel</button>
        </form>

        <table id="leapsTable">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Contract Info</th>
                    <th>Cost</th>
                    <th>Current Price</th>
                    <th>Expiry Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <script>
        // STOCKS
        const stockForm = document.getElementById("stockForm");
        const stocksTableBody = document.querySelector("#stocksTable tbody");
        const cancelStockEditBtn = document.getElementById("cancelStockEdit");
        let editingStockId = null;

        async function fetchStocks() {
            const res = await fetch("/stocks/");
            const stocks = await res.json();
            renderStocks(stocks);
        }

        function renderStocks(stocks) {
            stocksTableBody.innerHTML = "";
            stocks.forEach(stock => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${stock.ticker}</td>
                    <td>${stock.shares}</td>
                    <td>${stock.cost_basis?.toFixed(2) ?? ""}</td>
                    <td>${stock.market_price !== null && stock.market_price !== undefined ? stock.market_price.toFixed(2) : ""}</td>
                    <td>${stock.status}</td>
                    <td>${stock.entry_date ?? ""}</td>
                    <td>
                        <button onclick="startStockEdit(${stock.id})">Edit</button>
                        <button onclick="deleteStock(${stock.id})">Delete</button>
                    </td>
                `;
                stocksTableBody.appendChild(tr);
            });
        }

        function resetStockForm() {
            stockForm.id.value = "";
            stockForm.ticker.value = "";
            stockForm.shares.value = "";
            stockForm.cost_basis.value = "";
            stockForm.market_price.value = "";
            stockForm.status.value = "Open";
            stockForm.entry_date.value = "";
            editingStockId = null;
            cancelStockEditBtn.style.display = "none";
        }

        window.startStockEdit = function (id) {
            fetch(`/stocks/`)
                .then(res => res.json())
                .then(stocks => {
                    const stock = stocks.find(s => s.id === id);
                    if (!stock) {
                        alert("Stock not found.");
                        return;
                    }
                    stockForm.id.value = stock.id;
                    stockForm.ticker.value = stock.ticker;
                    stockForm.shares.value = stock.shares;
                    stockForm.cost_basis.value = stock.cost_basis ?? "";
                    stockForm.market_price.value = stock.market_price ?? "";
                    stockForm.status.value = stock.status ?? "Open";
                    stockForm.entry_date.value = stock.entry_date ?? "";
                    editingStockId = stock.id;
                    cancelStockEditBtn.style.display = "inline";
                })
                .catch(err => alert(err.message));
        };

        cancelStockEditBtn.addEventListener("click", e => {
            e.preventDefault();
            resetStockForm();
        });

        stockForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                ticker: stockForm.ticker.value.trim().toUpperCase(),
                shares: parseFloat(stockForm.shares.value),
                cost_basis: parseFloat(stockForm.cost_basis.value),
                market_price: stockForm.market_price.value ? parseFloat(stockForm.market_price.value) : null,
                status: stockForm.status.value,
                entry_date: stockForm.entry_date.value || null
            };

            try {
                let res;
                if (editingStockId) {
                    res = await fetch(`/stocks/${editingStockId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch("/stocks/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                }

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Failed to save stock");
                }

                resetStockForm();
                fetchStocks();
            } catch (err) {
                alert(err.message);
            }
        });

        window.deleteStock = async function (id) {
            if (!confirm("Are you sure you want to delete this stock?")) return;
            const res = await fetch(`/stocks/${id}`, { method: "DELETE" });
            if (res.ok) {
                fetchStocks();
            } else {
                alert("Failed to delete stock");
            }
        };

        // OPTIONS
        const optionForm = document.getElementById("optionForm");
        const optionsTableBody = document.querySelector("#optionsTable tbody");
        const cancelOptionEditBtn = document.getElementById("cancelOptionEdit");
        let editingOptionId = null;

        async function fetchOptions() {
            const res = await fetch("/options/");
            const options = await res.json();
            renderOptions(options);
        }

        function renderOptions(options) {
            optionsTableBody.innerHTML = "";
            options.forEach(opt => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${opt.ticker}</td>
                    <td>${opt.option_type}</td>
                    <td>${opt.strike_price?.toFixed(2) ?? ""}</td>
                    <td>${opt.expiry_date ?? ""}</td>
                    <td>${opt.contracts}</td>
                    <td>${opt.cost?.toFixed(2) ?? ""}</td>
                    <td>${opt.market_price_per_contract !== null && opt.market_price_per_contract !== undefined ? opt.market_price_per_contract.toFixed(2) : ""}</td>
                    <td>${opt.status}</td>
                    <td>
                        <button onclick="startOptionEdit(${opt.id})">Edit</button>
                        <button onclick="deleteOption(${opt.id})">Delete</button>
                    </td>
                `;
                optionsTableBody.appendChild(tr);
            });
        }

        function resetOptionForm() {
            optionForm.id.value = "";
            optionForm.ticker.value = "";
            optionForm.option_type.value = "";
            optionForm.strike_price.value = "";
            optionForm.expiry_date.value = "";
            optionForm.contracts.value = "";
            optionForm.cost.value = "";
            optionForm.market_price_per_contract.value = "";
            optionForm.status.value = "Open";
            editingOptionId = null;
            cancelOptionEditBtn.style.display = "none";
        }

        window.startOptionEdit = function (id) {
            fetch(`/options/`)
                .then(res => res.json())
                .then(options => {
                    const opt = options.find(o => o.id === id);
                    if (!opt) {
                        alert("Option not found.");
                        return;
                    }
                    optionForm.id.value = opt.id;
                    optionForm.ticker.value = opt.ticker;
                    optionForm.option_type.value = opt.option_type;
                    optionForm.strike_price.value = opt.strike_price;
                    optionForm.expiry_date.value = opt.expiry_date;
                    optionForm.contracts.value = opt.contracts;
                    optionForm.cost.value = opt.cost;
                    optionForm.market_price_per_contract.value = opt.market_price_per_contract ?? "";
                    optionForm.status.value = opt.status ?? "Open";
                    editingOptionId = opt.id;
                    cancelOptionEditBtn.style.display = "inline";
                })
                .catch(err => alert(err.message));
        };

        cancelOptionEditBtn.addEventListener("click", e => {
            e.preventDefault();
            resetOptionForm();
        });

        optionForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                ticker: optionForm.ticker.value.trim().toUpperCase(),
                option_type: optionForm.option_type.value,
                strike_price: parseFloat(optionForm.strike_price.value),
                expiry_date: optionForm.expiry_date.value,
                contracts: parseFloat(optionForm.contracts.value),
                cost: parseFloat(optionForm.cost.value),
                market_price_per_contract: optionForm.market_price_per_contract.value ? parseFloat(optionForm.market_price_per_contract.value) : null,
                status: optionForm.status.value
            };

            try {
                let res;
                if (editingOptionId) {
                    res = await fetch(`/options/${editingOptionId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch("/options/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                }

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Failed to save option");
                }

                resetOptionForm();
                fetchOptions();
            } catch (err) {
                alert(err.message);
            }
        });

        window.deleteOption = async function (id) {
            if (!confirm("Are you sure you want to delete this option?")) return;
            const res = await fetch(`/options/${id}`, { method: "DELETE" });
            if (res.ok) {
                fetchOptions();
            } else {
                alert("Failed to delete option");
            }
        };

        // LEAPS
        const leapForm = document.getElementById("leapForm");
        const leapsTableBody = document.querySelector("#leapsTable tbody");
        const cancelLeapEditBtn = document.getElementById("cancelLeapEdit");
        let editingLeapId = null;

        async function fetchLeaps() {
            const res = await fetch("/leaps/");
            const leaps = await res.json();
            renderLeaps(leaps);
        }

        function renderLeaps(leaps) {
            leapsTableBody.innerHTML = "";
            leaps.forEach(leap => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${leap.ticker}</td>
                    <td>${leap.contract_info}</td>
                    <td>${leap.cost?.toFixed(2) ?? ""}</td>
                    <td>${leap.current_price !== null && leap.current_price !== undefined ? leap.current_price.toFixed(2) : ""}</td>
                    <td>${leap.expiry_date ?? ""}</td>
                    <td>
                        <button onclick="startLeapEdit(${leap.id})">Edit</button>
                        <button onclick="deleteLeap(${leap.id})">Delete</button>
                    </td>
                `;
                leapsTableBody.appendChild(tr);
            });
        }

        function resetLeapForm() {
            leapForm.id.value = "";
            leapForm.ticker.value = "";
            leapForm.contract_info.value = "";
            leapForm.cost.value = "";
            leapForm.current_price.value = "";
            leapForm.expiry_date.value = "";
            editingLeapId = null;
            cancelLeapEditBtn.style.display = "none";
        }

        window.startLeapEdit = function (id) {
            fetch(`/leaps/`)
                .then(res => res.json())
                .then(leaps => {
                    const leap = leaps.find(l => l.id === id);
                    if (!leap) {
                        alert("LEAP not found.");
                        return;
                    }
                    leapForm.id.value = leap.id;
                    leapForm.ticker.value = leap.ticker;
                    leapForm.contract_info.value = leap.contract_info;
                    leapForm.cost.value = leap.cost ?? "";
                    leapForm.current_price.value = leap.current_price ?? "";
                    leapForm.expiry_date.value = leap.expiry_date ?? "";
                    editingLeapId = leap.id;
                    cancelLeapEditBtn.style.display = "inline";
                })
                .catch(err => alert(err.message));
        };

        cancelLeapEditBtn.addEventListener("click", e => {
            e.preventDefault();
            resetLeapForm();
        });

        leapForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                ticker: leapForm.ticker.value.trim().toUpperCase(),
                contract_info: leapForm.contract_info.value,
                cost: parseFloat(leapForm.cost.value),
                current_price: leapForm.current_price.value ? parseFloat(leapForm.current_price.value) : null,
                expiry_date: leapForm.expiry_date.value
            };

            try {
                let res;
                if (editingLeapId) {
                    res = await fetch(`/leaps/${editingLeapId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch("/leaps/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                }

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Failed to save LEAP");
                }

                resetLeapForm();
                fetchLeaps();
            } catch (err) {
                alert(err.message);
            }
        });

        window.deleteLeap = async function (id) {
            if (!confirm("Are you sure you want to delete this LEAP?")) return;
            const res = await fetch(`/leaps/${id}`, { method: "DELETE" });
            if (res.ok) {
                fetchLeaps();
            } else {
                alert("Failed to delete LEAP");
            }
        };

        // Initial load
        fetchStocks();
        fetchOptions();
        fetchLeaps();
    </script>
</body>

</html>