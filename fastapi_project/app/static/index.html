<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portfolio Positions</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 32px;
        }

        th,
        td {
            padding: 8px 12px;
            border: 1px solid #ccc;
        }

        form>* {
            margin: 0 8px 8px 0;
        }

        h2 {
            margin-top: 40px;
        }
    </style>
</head>

<body>
    <h1>Portfolio Positions</h1>

    <!-- STOCKS SECTION -->
    <section>
        <h2>Stocks</h2>
        <form id="stockForm">
            <input type="hidden" name="id" />
            <input name="ticker" placeholder="Ticker" required />
            <input name="shares" type="number" min="0" step="any" placeholder="Shares" required />
            <input name="cost_basis" type="number" step="0.01" min="0" placeholder="Cost Basis" required />
            <input name="market_price" type="number" step="0.01" min="0" placeholder="Market Price" />
            <select name="status" required>
                <option value="Open">Open</option>
                <option value="Sold">Sold</option>
            </select>
            <input name="entry_date" type="date" placeholder="Entry Date" />
            <button type="submit">Add / Update Stock</button>
            <button type="button" id="cancelStockEdit" style="display:none;">Cancel</button>
        </form>

        <table id="stocksTable">
            <thead>
                <tr>
                    <th>Ticker</th>
                    <th>Shares</th>
                    <th>Cost Basis</th>
                    <th>Market Price</th>
                    <th>Status</th>
                    <th>Entry Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- OPTIONS SECTION -->
    <section>
        <h2>Options</h2>
        <form id="optionForm">
            <input type="hidden" name="id" />
            <input name="symbol" placeholder="Symbol" required />
            <input name="quantity" type="number" min="1" placeholder="Quantity" required />
            <input name="average_price" type="number" step="0.01" min="0" placeholder="Average Price" required />
            <input name="strike" type="number" step="0.01" min="0" placeholder="Strike Price" required />
            <select name="option_type" required>
                <option value="" disabled selected>Option Type</option>
                <option value="call">Call</option>
                <option value="put">Put</option>
            </select>
            <input name="expiration_date" type="date" placeholder="Expiration Date" required />
            <button type="submit">Add / Update Option</button>
            <button type="button" id="cancelOptionEdit" style="display:none;">Cancel</button>
        </form>

        <table id="optionsTable">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Quantity</th>
                    <th>Average Price</th>
                    <th>Strike</th>
                    <th>Type</th>
                    <th>Expiration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <script>
        // STOCKS
        const stockForm = document.getElementById("stockForm");
        const stocksTableBody = document.querySelector("#stocksTable tbody");
        const cancelStockEditBtn = document.getElementById("cancelStockEdit");
        let editingStockId = null;

        async function fetchStocks() {
            const res = await fetch("/stocks/");
            const stocks = await res.json();
            renderStocks(stocks);
        }

        function renderStocks(stocks) {
            stocksTableBody.innerHTML = "";
            stocks.forEach(stock => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${stock.ticker}</td>
                    <td>${stock.shares}</td>
                    <td>${stock.cost_basis?.toFixed(2) ?? ""}</td>
                    <td>${stock.market_price !== null && stock.market_price !== undefined ? stock.market_price.toFixed(2) : ""}</td>
                    <td>${stock.status}</td>
                    <td>${stock.entry_date ?? ""}</td>
                    <td>
                        <button onclick="startStockEdit(${stock.id})">Edit</button>
                        <button onclick="deleteStock(${stock.id})">Delete</button>
                    </td>
                `;
                stocksTableBody.appendChild(tr);
            });
        }

        function resetStockForm() {
            stockForm.id.value = "";
            stockForm.ticker.value = "";
            stockForm.shares.value = "";
            stockForm.cost_basis.value = "";
            stockForm.market_price.value = "";
            stockForm.status.value = "Open";
            stockForm.entry_date.value = "";
            editingStockId = null;
            cancelStockEditBtn.style.display = "none";
        }

        window.startStockEdit = function (id) {
            fetch(`/stocks/`)
                .then(res => res.json())
                .then(stocks => {
                    const stock = stocks.find(s => s.id === id);
                    if (!stock) {
                        alert("Stock not found.");
                        return;
                    }
                    stockForm.id.value = stock.id;
                    stockForm.ticker.value = stock.ticker;
                    stockForm.shares.value = stock.shares;
                    stockForm.cost_basis.value = stock.cost_basis ?? "";
                    stockForm.market_price.value = stock.market_price ?? "";
                    stockForm.status.value = stock.status ?? "Open";
                    stockForm.entry_date.value = stock.entry_date ?? "";
                    editingStockId = stock.id;
                    cancelStockEditBtn.style.display = "inline";
                })
                .catch(err => alert(err.message));
        };

        cancelStockEditBtn.addEventListener("click", e => {
            e.preventDefault();
            resetStockForm();
        });

        stockForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                ticker: stockForm.ticker.value.trim().toUpperCase(),
                shares: parseFloat(stockForm.shares.value),
                cost_basis: parseFloat(stockForm.cost_basis.value),
                market_price: stockForm.market_price.value ? parseFloat(stockForm.market_price.value) : null,
                status: stockForm.status.value,
                entry_date: stockForm.entry_date.value || null
            };

            try {
                let res;
                if (editingStockId) {
                    res = await fetch(`/stocks/${editingStockId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch("/stocks/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                }

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Failed to save stock");
                }

                resetStockForm();
                fetchStocks();
            } catch (err) {
                alert(err.message);
            }
        });

        window.deleteStock = async function (id) {
            if (!confirm("Are you sure you want to delete this stock?")) return;
            const res = await fetch(`/stocks/${id}`, { method: "DELETE" });
            if (res.ok) {
                fetchStocks();
            } else {
                alert("Failed to delete stock");
            }
        };

        // OPTIONS
        const optionForm = document.getElementById("optionForm");
        const optionsTableBody = document.querySelector("#optionsTable tbody");
        const cancelOptionEditBtn = document.getElementById("cancelOptionEdit");
        let editingOptionId = null;

        async function fetchOptions() {
            const res = await fetch("/option_positions/");
            const options = await res.json();
            renderOptions(options);
        }

        function renderOptions(options) {
            optionsTableBody.innerHTML = "";
            options.forEach(pos => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${pos.symbol}</td>
                    <td>${pos.quantity}</td>
                    <td>${pos.average_price?.toFixed(2) ?? ""}</td>
                    <td>${pos.strike_price?.toFixed(2) ?? ""}</td>
                    <td>${pos.option_type ? pos.option_type.charAt(0).toUpperCase() + pos.option_type.slice(1) : ""}</td>
                    <td>${pos.expiration_date ?? ""}</td>
                    <td>
                        <button onclick="startOptionEdit(${pos.id})">Edit</button>
                        <button onclick="deleteOption(${pos.id})">Delete</button>
                    </td>
                `;
                optionsTableBody.appendChild(tr);
            });
        }

        function resetOptionForm() {
            optionForm.id.value = "";
            optionForm.symbol.value = "";
            optionForm.quantity.value = "";
            optionForm.average_price.value = "";
            optionForm.strike.value = "";
            optionForm.option_type.value = "";
            optionForm.expiration_date.value = "";
            editingOptionId = null;
            cancelOptionEditBtn.style.display = "none";
        }

        optionForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                symbol: optionForm.symbol.value.trim().toUpperCase(),
                quantity: parseInt(optionForm.quantity.value),
                average_price: parseFloat(optionForm.average_price.value),
                strike_price: parseFloat(optionForm.strike.value),
                option_type: optionForm.option_type.value,
                expiration_date: optionForm.expiration_date.value
            };

            try {
                let res;
                if (editingOptionId) {
                    res = await fetch(`/option_positions/${editingOptionId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch("/option_positions/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                }

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Failed to save option position");
                }

                resetOptionForm();
                fetchOptions();
                fetchStocks(); // refresh stocks just in case
            } catch (err) {
                alert(err.message);
            }
        });

        window.startOptionEdit = function (id) {
            fetch(`/option_positions/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error("Option position not found");
                    return res.json();
                })
                .then(pos => {
                    optionForm.id.value = pos.id;
                    optionForm.symbol.value = pos.symbol;
                    optionForm.quantity.value = pos.quantity;
                    optionForm.average_price.value = pos.average_price ?? "";
                    optionForm.strike.value = pos.strike_price;
                    optionForm.option_type.value = pos.option_type;
                    optionForm.expiration_date.value = pos.expiration_date;
                    editingOptionId = pos.id;
                    cancelOptionEditBtn.style.display = "inline";
                })
                .catch(err => alert(err.message));
        };

        window.deleteOption = async function (id) {
            if (!confirm("Are you sure you want to delete this option position?")) return;
            const res = await fetch(`/option_positions/${id}`, { method: "DELETE" });
            if (res.ok) {
                fetchOptions();
            } else {
                alert("Failed to delete option position");
            }
        };

        // Initial load
        fetchStocks();
        fetchOptions();
    </script>
</body>

</html>