<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Portfolio Positions</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 32px;
        }

        th,
        td {
            padding: 8px 12px;
            border: 1px solid #ccc;
        }

        form>* {
            margin: 0 8px 8px 0;
        }

        h2 {
            margin-top: 40px;
        }
    </style>
</head>

<body>
    <h1>Portfolio Positions</h1>

    <!-- STOCKS SECTION -->
    <section>
        <h2>Stocks</h2>
        <form id="stockForm">
            <input type="hidden" name="id" />
            <input name="symbol" placeholder="Symbol" required />
            <input name="quantity" type="number" min="1" placeholder="Quantity" required />
            <input name="average_price" type="number" step="0.01" min="0" placeholder="Average Price" required />
            <button type="submit">Add / Update Stock</button>
            <button type="button" id="cancelStockEdit" style="display:none;">Cancel</button>
        </form>

        <table id="stocksTable">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Quantity</th>
                    <th>Average Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <!-- OPTIONS SECTION -->
    <section>
        <h2>Options</h2>
        <form id="optionForm">
            <input type="hidden" name="id" />
            <input name="symbol" placeholder="Symbol" required />
            <input name="quantity" type="number" min="1" placeholder="Quantity" required />
            <input name="average_price" type="number" step="0.01" min="0" placeholder="Average Price" required />
            <input name="strike" type="number" step="0.01" min="0" placeholder="Strike Price" required />
            <select name="option_type" required>
                <option value="" disabled selected>Option Type</option>
                <option value="call">Call</option>
                <option value="put">Put</option>
            </select>
            <input name="expiration_date" type="date" placeholder="Expiration Date" required />
            <button type="submit">Add / Update Option</button>
            <button type="button" id="cancelOptionEdit" style="display:none;">Cancel</button>
        </form>

        <table id="optionsTable">
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Quantity</th>
                    <th>Average Price</th>
                    <th>Strike</th>
                    <th>Type</th>
                    <th>Expiration</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </section>

    <script>
        // STOCKS
        const stockForm = document.getElementById("stockForm");
        const stocksTableBody = document.querySelector("#stocksTable tbody");
        const cancelStockEditBtn = document.getElementById("cancelStockEdit");
        let editingStockId = null;

        async function fetchStocks() {
            const res = await fetch("/positions/?type=stock");
            const stocks = await res.json();
            renderStocks(stocks);
        }

        function renderStocks(stocks) {
            stocksTableBody.innerHTML = "";
            stocks.forEach(pos => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${pos.symbol}</td>
                    <td>${pos.quantity}</td>
                    <td>${pos.average_price?.toFixed(2) ?? ""}</td>
                    <td>
                        <button onclick="startStockEdit(${pos.id})">Edit</button>
                        <button onclick="deleteStock(${pos.id})">Delete</button>
                    </td>
                `;
                stocksTableBody.appendChild(tr);
            });
        }

        function resetStockForm() {
            stockForm.id.value = "";
            stockForm.symbol.value = "";
            stockForm.quantity.value = "";
            stockForm.average_price.value = "";
            editingStockId = null;
            cancelStockEditBtn.style.display = "none";
        }

        function startStockEdit(id) {
            fetch(`/positions/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error("Position not found");
                    return res.json();
                })
                .then(pos => {
                    if (pos.type !== 'stock') {
                        alert("This is not a stock position.");
                        return;
                    }
                    stockForm.id.value = pos.id;
                    stockForm.symbol.value = pos.symbol;
                    stockForm.quantity.value = pos.quantity;
                    stockForm.average_price.value = pos.average_price ?? "";
                    editingStockId = pos.id;
                    cancelStockEditBtn.style.display = "inline";
                })
                .catch(err => alert(err.message));
        }

        cancelStockEditBtn.addEventListener("click", e => {
            e.preventDefault();
            resetStockForm();
        });

        stockForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                symbol: stockForm.symbol.value.trim().toUpperCase(),
                quantity: parseInt(stockForm.quantity.value),
                average_price: parseFloat(stockForm.average_price.value),
                type: "stock"
            };

            try {
                let res;
                if (editingStockId) {
                    res = await fetch(`/positions/${editingStockId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch("/positions/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                }

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Failed to save position");
                }

                resetStockForm();
                fetchStocks();
                fetchOptions(); // refresh options just in case
            } catch (err) {
                alert(err.message);
            }
        });

        async function deleteStock(id) {
            if (!confirm("Are you sure you want to delete this stock position?")) return;
            const res = await fetch(`/positions/${id}`, { method: "DELETE" });
            if (res.ok) {
                fetchStocks();
            } else {
                alert("Failed to delete position");
            }
        }

        // OPTIONS
        const optionForm = document.getElementById("optionForm");
        const optionsTableBody = document.querySelector("#optionsTable tbody");
        const cancelOptionEditBtn = document.getElementById("cancelOptionEdit");
        let editingOptionId = null;

        async function fetchOptions() {
            const res = await fetch("/positions/?type=option");
            const options = await res.json();
            renderOptions(options);
        }

        function renderOptions(options) {
            optionsTableBody.innerHTML = "";
            options.forEach(pos => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${pos.symbol}</td>
                    <td>${pos.quantity}</td>
                    <td>${pos.average_price?.toFixed(2) ?? ""}</td>
                    <td>${pos.strike.toFixed(2)}</td>
                    <td>${pos.option_type.charAt(0).toUpperCase() + pos.option_type.slice(1)}</td>
                    <td>${pos.expiration_date}</td>
                    <td>
                        <button onclick="startOptionEdit(${pos.id})">Edit</button>
                        <button onclick="deleteOption(${pos.id})">Delete</button>
                    </td>
                `;
                optionsTableBody.appendChild(tr);
            });
        }

        function resetOptionForm() {
            optionForm.id.value = "";
            optionForm.symbol.value = "";
            optionForm.quantity.value = "";
            optionForm.average_price.value = "";
            optionForm.strike.value = "";
            optionForm.option_type.value = "";
            optionForm.expiration_date.value = "";
            editingOptionId = null;
            cancelOptionEditBtn.style.display = "none";
        }

        function startOptionEdit(id) {
            fetch(`/positions/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error("Position not found");
                    return res.json();
                })
                .then(pos => {
                    if (pos.type !== 'option') {
                        alert("This is not an option position.");
                        return;
                    }
                    optionForm.id.value = pos.id;
                    optionForm.symbol.value = pos.symbol;
                    optionForm.quantity.value = pos.quantity;
                    optionForm.average_price.value = pos.average_price ?? "";
                    optionForm.strike.value = pos.strike;
                    optionForm.option_type.value = pos.option_type;
                    optionForm.expiration_date.value = pos.expiration_date;
                    editingOptionId = pos.id;
                    cancelOptionEditBtn.style.display = "inline";
                })
                .catch(err => alert(err.message));
        }

        cancelOptionEditBtn.addEventListener("click", e => {
            e.preventDefault();
            resetOptionForm();
        });

        optionForm.addEventListener("submit", async e => {
            e.preventDefault();
            const data = {
                symbol: optionForm.symbol.value.trim().toUpperCase(),
                quantity: parseInt(optionForm.quantity.value),
                average_price: parseFloat(optionForm.average_price.value),
                strike: parseFloat(optionForm.strike.value),
                option_type: optionForm.option_type.value,
                expiration_date: optionForm.expiration_date.value,
                type: "option"
            };

            try {
                let res;
                if (editingOptionId) {
                    res = await fetch(`/positions/${editingOptionId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                } else {
                    res = await fetch("/positions/", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data),
                    });
                }

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.detail || "Failed to save position");
                }

                resetOptionForm();
                fetchOptions();
                fetchStocks(); // refresh stocks just in case
            } catch (err) {
                alert(err.message);
            }
        });

        async function deleteOption(id) {
            if (!confirm("Are you sure you want to delete this option position?")) return;
            const res = await fetch(`/positions/${id}`, { method: "DELETE" });
            if (res.ok) {
                fetchOptions();
            } else {
                alert("Failed to delete position");
            }
        }

        // Initial load
        fetchStocks();
        fetchOptions();
    </script>
</body>

</html>